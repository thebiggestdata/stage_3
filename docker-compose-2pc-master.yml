# ============================================================================
# PC1 - MASTER (2 PC SETUP)
# ============================================================================
# Use this file if you only have 2 PCs
# Run with: docker-compose --env-file .env -f docker-compose-2pc-master.yml up --build
# ============================================================================

services:
  # ActiveMQ Message Broker
  activemq:
    image: apache/activemq-classic:5.18.3
    container_name: activemq
    network_mode: host
    restart: unless-stopped
    environment:
      - ACTIVEMQ_BROKER_NAME=master-broker

  # Ingestion Service
  ingestion:
    build:
      context: .
      dockerfile: ingestion-service/Dockerfile
    container_name: ingestion-pc1
    environment:
      - NODE_ID=ingestion-pc1
      - SERVER_PORT=7001
      - HZ_PORT=5701
      - HZ_CLUSTER_NAME=${HZ_CLUSTER_NAME}
      - HZ_PUBLIC_ADDRESS=${PC1_IP}:5701
      - HZ_MEMBERS=${PC1_IP}:5701,${PC1_IP}:5702,${PC1_IP}:5703,${PC2_IP}:5701,${PC2_IP}:5702,${PC2_IP}:5703
      - BROKER_URL=tcp://localhost:61616
    restart: unless-stopped
    network_mode: host
    depends_on:
      - activemq

  # Indexing Service  
  indexing:
    build:
      context: .
      dockerfile: indexing-service/Dockerfile
    container_name: indexing-pc1
    environment:
      - NODE_ID=indexing-pc1
      - SERVER_PORT=7002
      - HZ_PORT=5702
      - HZ_CLUSTER_NAME=${HZ_CLUSTER_NAME}
      - HZ_PUBLIC_ADDRESS=${PC1_IP}:5702
      - HZ_MEMBERS=${PC1_IP}:5701,${PC1_IP}:5702,${PC1_IP}:5703,${PC2_IP}:5701,${PC2_IP}:5702,${PC2_IP}:5703
      - BROKER_URL=tcp://localhost:61616
      - QUEUE_NAME=ingested.document
      - WORKER_COUNT=4
    restart: unless-stopped
    network_mode: host
    depends_on:
      - activemq

  # Search Service
  search:
    build:
      context: .
      dockerfile: search-service/Dockerfile
    container_name: search-pc1
    environment:
      - NODE_ID=search-pc1
      - SERVER_PORT=7003
      - HZ_PORT=5703
      - HZ_CLUSTER_NAME=${HZ_CLUSTER_NAME}
      - HZ_PUBLIC_ADDRESS=${PC1_IP}:5703
      - HZ_MEMBERS=${PC1_IP}:5701,${PC1_IP}:5702,${PC1_IP}:5703,${PC2_IP}:5701,${PC2_IP}:5702,${PC2_IP}:5703
      - SORT_BY=frequency
    restart: unless-stopped
    network_mode: host
