services:
  activemq:
    image: rmohr/activemq:latest
    container_name: activemq
    ports:
      - "61616:61616"
      - "8161:8161"
    volumes:
      - activemq_data:/opt/activemq/data
    environment:
      - ACTIVEMQ_OPTS=-Dorg.apache.activemq.UseDedicatedTaskRunner=false
    networks:
      - search_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8161"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  hazelcast1:
    image: hazelcast/hazelcast:5.6.0
    container_name: hazelcast1
    environment:
      - HZ_CLUSTERNAME=SearchEngine
      - JAVA_OPTS=-Dhazelcast.config=/opt/hazelcast/config/hazelcast.xml
    ports:
      - "5701:5701"
    volumes:
      - ./hazelcast.xml:/opt/hazelcast/config/hazelcast.xml:ro
    networks:
      - search_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5701/hazelcast/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  hazelcast2:
    image: hazelcast/hazelcast:5.6.0
    container_name: hazelcast2
    environment:
      - HZ_CLUSTERNAME=SearchEngine
      - JAVA_OPTS=-Dhazelcast.config=/opt/hazelcast/config/hazelcast.xml
    volumes:
      - ./hazelcast.xml:/opt/hazelcast/config/hazelcast.xml:ro
    networks:
      - search_net
    depends_on:
      - hazelcast1
    restart: unless-stopped

  hazelcast3:
    image: hazelcast/hazelcast:5.6.0
    container_name: hazelcast3
    environment:
      - HZ_CLUSTERNAME=SearchEngine
      - JAVA_OPTS=-Dhazelcast.config=/opt/hazelcast/config/hazelcast.xml
    volumes:
      - ./hazelcast.xml:/opt/hazelcast/config/hazelcast.xml:ro
    networks:
      - search_net
    depends_on:
      - hazelcast1
    restart: unless-stopped

  ingestion-service:
    container_name: ingestion-service
    build:
      context: .
      dockerfile: ingestion-service/Dockerfile
    depends_on:
      activemq:
        condition: service_healthy
      hazelcast1:
        condition: service_healthy
    environment:
      - BROKER_URL=tcp://activemq:61616
      - HZ_CLUSTER_NAME=SearchEngine
      - HZ_MEMBERS=hazelcast1:5701,hazelcast2:5701,hazelcast3:5701
      - REPLICATION_FACTOR=3
      - NODE_NAME=ingestion-1
    volumes:
      - shared_datalake:/app/datalake
    networks:
      - search_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  indexing-service:
    build:
      context: .
      dockerfile: indexing-service/Dockerfile
    depends_on:
      activemq:
        condition: service_healthy
      hazelcast1:
        condition: service_healthy
    environment:
      - BROKER_URL=tcp://activemq:61616
      - HZ_CLUSTER_NAME=SearchEngine
      - HZ_MEMBERS=hazelcast1:5701,hazelcast2:5701,hazelcast3:5701
    volumes:
      - shared_datalake:/app/datalake
    networks:
      - search_net
    deploy:
      replicas: 3
    restart: unless-stopped

  search-service:
    build:
      context: .
      dockerfile: search-service/Dockerfile
    depends_on:
      hazelcast1:
        condition: service_healthy
    environment:
      - HZ_CLUSTER_NAME=SearchEngine
      - HZ_MEMBERS=hazelcast1:5701,hazelcast2:5701,hazelcast3:5701
    networks:
      - search_net
    deploy:
      replicas: 3
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    container_name: nginx-lb
    ports:
      - "80:80"
      - "7001:7001"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - search-service
      - ingestion-service
    networks:
      - search_net
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

volumes:
  shared_datalake:
    driver: local
  activemq_data:
    driver: local

networks:
  search_net:
    driver: bridge
