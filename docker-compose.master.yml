services:
  # ========================================
  # ACTIVEMQ - Message Broker Central
  # ========================================
  activemq:
    image: rmohr/activemq:latest
    container_name: activemq
    network_mode: "host"
    volumes:
      - activemq_data:/opt/activemq/data
    environment:
      - ACTIVEMQ_OPTS=-Dorg.apache.activemq.UseDedicatedTaskRunner=false
    restart: unless-stopped

  # ========================================
  # HAZELCAST MEMBER 1
  # ========================================
  hazelcast1:
    image: hazelcast/hazelcast:5.6.0
    container_name: hazelcast1
    network_mode: "host"
    environment:
      - HZ_CLUSTERNAME=SearchEngine
      - JAVA_OPTS=-Dhazelcast.config=/opt/hazelcast/config/hazelcast.xml
      - HZ_PUBLIC_ADDRESS=${HOST_IP}:5701
      - HZ_SEED_MEMBERS=${HOST_IP}:5701
    volumes:
      - ./hazelcast.xml:/opt/hazelcast/config/hazelcast.xml:ro
    restart: unless-stopped

  # ========================================
  # INGESTION SERVICE (Maestro)
  # ========================================
  ingestion-service:
    container_name: ingestion-service
    build:
      context: .
      dockerfile: ingestion-service/Dockerfile
    network_mode: "host"
    depends_on:
      - activemq
      - hazelcast1
    environment:
      - BROKER_URL=tcp://${HOST_IP}:61616
      - HZ_CLUSTER_NAME=SearchEngine
      - HZ_MEMBERS=${HOST_IP}:5701,${WORKER1_IP}:5701,${WORKER2_IP}:5701
      - REPLICATION_FACTOR=2
      - NODE_NAME=ingestion-master
      - DATALAKE_PATH=/shared/datalake
    volumes:
      - /shared/datalake:/shared/datalake
    restart: unless-stopped

  # ========================================
  # NGINX Load Balancer
  # ========================================
  nginx:
    image: nginx:alpine
    container_name: nginx-lb
    network_mode: "host"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - ingestion-service
    restart: unless-stopped

volumes:
  activemq_data:
    driver: local